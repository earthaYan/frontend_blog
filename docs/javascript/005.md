---
title: 异步2
titleTemplate: JavaScript
outline: "deep"
---

# 异步 2

![堆栈示意图](./imgs/005_stack.svg)

- 栈：函数调用形成了一个由若干帧堆叠而成的栈。
- 堆：对象被分配在堆中，堆是一个用来表示一大块（通常是非结构化的）内存区域的计算机术语
- 队列：JS 运行时包含一个待处理消息的消息队列,每一个消息都关联着一个用以处理这个消息的回调函数。

## 微任务 vs 宏任务

## event loop

作用：事件循环负责执行代码、收集和处理事件以及执行队列中的子任务,是 js 异步回调的实现原理。

执行步骤：

1. 同步代码逐行放在 call stack(执行栈) 执行
2. 遇到异步，相关的回调函数会被记录在任务队列中（callback queue 或 microtask queue）。移动到 web apis 等待时机(定时、网络请求)
3. 时机到了，就移动到相应的队列中
   - 微任务队列(microtask queue):Promise 的 .then()、MutationObserver 等会被放到微任务队列。
   - 宏任务队列(callback queue):setTimeout、setInterval 等回调会进入任务队列。
4. 若 call stack 为空(同步代码执行完成),event loop 开始工作
5. 轮询查找任务队列，有则移动到 call stack 执行
   - 先检查微任务队列（microtask queue），如果有任务，会优先执行微任务队列中的所有任务（会一直执行直到队列为空）。
   - 检查宏任务队列（callback queue），如果有任务，就会将它们逐个移到执行栈并执行。
6. 继续轮询查找重复上述步骤

## async/await

## Promise

| 状态     | 表现                 | then/catch 对状态的影响 |
| -------- | -------------------- | ----------------------- |
| pending  | 不会触发 then、catch |                         |
| resolved | 会触发 then          |                         |
| rejected | 会触发 catch         |                         |
