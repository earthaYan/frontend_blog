---
title: reactåŸç†
titleTemplate: react
outline: "deep"
---

# react åº•å±‚åŸç†

è™šæ‹Ÿ DOM æ˜¯å®ç° Vue å’Œ React çš„åŸºç¡€ï¼Œdiff ç®—æ³•æ˜¯è™šæ‹Ÿ DOM ä¸­æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ã€‚

## è™šæ‹Ÿ DOM

å‰æï¼šDOM æ“ä½œéå¸¸è€—è´¹æ€§èƒ½ï¼Œè€Œ js æ‰§è¡Œé€Ÿåº¦å¿«ï¼ŒVue å’Œ React æ˜¯æ•°æ®é©±åŠ¨è§†å›¾ï¼Œé¡¹ç›®è¶Šå¤æ‚ï¼ŒDOM æ“ä½œè¶Šæ¥è¶Šå¤šï¼Œè€—è´¹æ€§èƒ½

ç›®æ ‡ï¼šæœ‰æ•ˆæ§åˆ¶ DOM æ“ä½œ

è§£å†³æ–¹æ¡ˆï¼šè™šæ‹Ÿ DOMï¼Œç”¨ JS æ¨¡æ‹Ÿ DOM ç»“æ„ï¼Œè®¡ç®—å‡ºæœ€å°çš„å˜æ›´èŒƒå›´åå†æ›´æ–° DOMï¼Œæœ‰æ•ˆæ§åˆ¶ DOM æ“ä½œ

### diff ç®—æ³•

diff(å¯¹æ¯”) ç®—æ³•åœ¨ MVVM æ¡†æ¶æ—¥å¸¸ä½¿ç”¨ä¸­çš„ä½“ç°ï¼šæ¯”å¦‚ key

æ—¶é—´å¤æ‚åº¦ï¼šO(n^3)->O(n)

è¿‡ç¨‹ï¼š

1. éå† tree1 å’Œ tree2
2. æ’åº

> é—®é¢˜ï¼š1000 ä¸ªèŠ‚ç‚¹ï¼Œè¦è®¡ç®— 1 äº¿æ¬¡ï¼Œç®—æ³•ä¸å¯ç”¨

æ—¶é—´å¤æ‚åº¦ O(n):

1. åªæ¯”è¾ƒåŒä¸€å±‚çº§ï¼Œä¸è·¨çº§æ¯”è¾ƒ
   ![åŒçº§æ¯”è¾ƒ](./imgs/007_diff.awebp)
2. tag ä¸ç›¸åŒï¼Œåˆ™ç›´æ¥åˆ æ‰é‡å»ºï¼Œä¸å†æ·±åº¦æ¯”è¾ƒ
   ![ä¸åŒtag](./imgs/007_diff_tag.jpg)
3. tag å’Œ key éƒ½ç›¸åŒï¼Œåˆ™è®¤ä¸ºæ˜¯ç›¸åŒèŠ‚ç‚¹ï¼Œä¸å†æ·±åº¦æ¯”è¾ƒ

### ç”¨ JS æ¨¡æ‹Ÿ DOM ç»“æ„ VNode

vNode:è™šæ‹ŸèŠ‚ç‚¹ï¼Œæ˜¯ä¸€æ£µæ ‘

```js
const vNode = {
  tag: "div",
  props: {
    className: "container",
    id: "div1",
  },
  children: [
    {
      tag: "p",
      children: "vdom",
    },
    {
      tag: "ul",
      props: { style: "font-size:20px" },
      children: [
        {
          tag: "li",
          children: "a",
        },
      ],
    },
  ],
};
```

### h å‡½æ•°

æ¥å—ä¸‰ä¸ªå‚æ•°,è¿”å› VNode å¯¹è±¡

1. æ ‡ç­¾
2. å±æ€§ props
3. children

::: code-group

```js [vNode]
//elemï¼švNodeå¯¹åº”çš„DOMå…ƒç´ 
function vNode(selector, data, children, text, elm) {
  let key = data === undefined ? undefined : data.key;
  return { selector, data, children, text, elm, key };
}
```

```ts [hå‡½æ•°]
function h(selector: string): VNode;
function h(selector: string, data: VNodeData | null): VNode;
function h(selector: string, children: VNodeChildren): VNode;
function h(
  selector: string,
  data: VNodeData | null,
  children: VNodeChildren | null
): VNode;
function h(selector, b?: any, c?: any): VNode {
  var data: VNodeData = {},
    children: any;text:any,i:number
 //å…·ä½“å®ç°
 //æœ€ç»ˆè¿”å›
 return vNode(selector,data,children,text,undefined)
}
```

:::

### patch å‡½æ•°

è¯­æ³•ï¼š

- åˆæ¬¡æ¸²æŸ“ï¼š`patch(container,vNode)`
- DOM æ›´æ–°ï¼š`patch(vNode,newVNode)`
- é”€æ¯ DOM:`patch(newVNode,null)`

```ts
function patch(oldVNode: VNode | Element, vNode: VNode) {
  if (!isVNode(oldVNode)) {
    //åˆ›å»ºç©ºçš„vnodeï¼Œå…³è”åˆ°è¿™ä¸ªdomå…ƒç´ 
  }
  if (sameVNode(oldVNode, vNode)) {
    // ç›¸åŒçš„vnodeï¼ˆkeyå’Œselectoréƒ½ç›¸åŒï¼‰ï¼Œè¿›è¡Œå¯¹æ¯”
    //æ‰§è¡Œprepatch hook
    //è®¾ç½®vnode.element
    const elm = (vNode.elm = oldVNode.elm!);
    const oldChildren = oldVNode.children;
    const children = vNode.children;
    //åˆ¤æ–­æ–°çš„vNode.textä¸ºundefined
    if (isUndef(vNode.text)) {
      if (isDef(oldChildren) && isDef(children)) {
        if (oldChildren !== children) {
          //æ–°æ—§éƒ½æœ‰children
          updateChildren();
        }
      } else if (isDef(children)) {
        //æ–°childrenæœ‰ï¼Œæ—§childrenæ— (æ—§textæœ‰)
        //æ¸…ç©ºtextæ·»åŠ children
      } else if (isDef(oldChildren)) {
        //æ—§childrenæœ‰ï¼Œæ–°childrenæ— 
        //ç§»é™¤children
      } else if (isDef(oldVNode.text)) {
        //æ—§textæœ‰ï¼Œè®¾ç½®text
      }
    } else if (oldVNode.text !== vNode.text) {
      //ç§»é™¤æ—§çš„childrenå¹¶è®¾ç½®æ–°çš„text
    }
  } else {
    //ä¸åŒçš„vnode,ç›´æ¥åˆ é™¤é‡å»º
  }
}
```

### updateChildren å‡½æ•°

æ–°æ—§ä¸¤ä¸ª children éƒ½ä½¿ç”¨åŒæŒ‡é’ˆå¾€ä¸­é—´éå†

```ts
function updateChildren(
  parentElem: Node,
  oldChildren: VNode[],
  children: VNode[],
  insertedVNodeQueue: VNodeQueue
) {
  let oldStartIdx = 0,
    oldEndIdx = oldChildren.length - 1,
    oldStartVNode = oldChildren[0],
    oldEndVNode = oldChildren[oldEndIdx],
    newStartIdx = 0,
    newEndIdx = Children.length - 1,
    newStartVNode = children[0],
    newEndVNode = children[newEndIdx];
  while (oldStartIdx <= oldEndIdx && newStartIdx <= newEndIdx) {
    if (oldStartVNode === null) {
    } else if (oldEndVNode === null) {
    } else if (newStartVNode === null) {
    } else if (newEndVNode === null) {
    } else if (sameVNode(oldStartVNode, newStartVNode)) {
      //å¼€å§‹å’Œå¼€å§‹å¯¹æ¯”
      patchVNode(oldStartVNode, newStartVNode, insertedVNodeQueue);
      oldStartVNode = oldChildren[++oldStartIdx];
      newStartVNode = children[++newStartIdx];
    } else if (sameVNode(oldEndVNode, newEndVNode)) {
      //ç»“æŸå’Œç»“æŸå¯¹æ¯”
      patchVNode(oldEndVNode, newEndVNode, insertedVNodeQueue);
      oldEndVNode = oldChildren[--oldEndIdx];
      newEndVNode = children[--newEndIdx];
    } else if (sameVNode(oldStartVNode, newEndVNode)) {
      //æ—§childrençš„å¼€å§‹å’Œæ–°childrenç»“æŸå¯¹æ¯”
      patchVNode(oldStartVNode, newEndVNode, insertedVNodeQueue);
      //æ’å…¥
      //...
      oldStartVNode = oldChildren[++oldStartIdx];
      newEndVNode = children[--newEndIdx];
    } else if (sameVNode(oldEndVNode, newStartVNode)) {
      //æ—§childrenç»“æŸå’Œæ–°çš„childrenå¼€å§‹å¯¹æ¯”
      patchVNode(oldEndVNode, newStartVNode, insertedVNodeQueue);
      //æ’å…¥
      //...
      oldEndVNode = oldChildren[--oldEndIdx];
      newStartVNode = children[++newStartIdx];
    } else {
      //ä»¥ä¸Šå››ä¸ªéƒ½æœªå‘½ä¸­
    }
  }
}
```

### æ€»ç»“ï¼š

æ ¸å¿ƒæ¦‚å¿µï¼š

- h:åˆ›å»ºè™šæ‹Ÿ DOM èŠ‚ç‚¹
- vnode:è™šæ‹Ÿ DOM èŠ‚ç‚¹,æ˜¯å¯¹çœŸå® DOM çš„ JS å¯¹è±¡æè¿°
- patch:å¯¹æ¯”æ–°æ—§èŠ‚ç‚¹ï¼Œç„¶åé«˜æ•ˆæ›´æ–° DOM
  1. åˆ›å»ºèŠ‚ç‚¹(vnode->DOM)
  2. æ¯”è¾ƒæ–°æ—§ vnode(diff)
  3. æ›´æ–°å·®å¼‚(åªæ”¹åŠ¨æœ‰å˜åŒ–çš„éƒ¨åˆ†)
     > å¦‚æœæ–°æ—§èŠ‚ç‚¹å®Œå…¨ä¸ä¸€æ ·ï¼Œåˆ™ç›´æ¥é”€æ¯æ—§èŠ‚ç‚¹ï¼Œåˆ›å»ºæ–°èŠ‚ç‚¹ï¼›é€’å½’å¯¹å­èŠ‚ç‚¹æ‰§è¡Œ patch
- diff:æ ¸å¿ƒæ¯”å¯¹ç®—æ³•,æœ€å°åŒ– DOM æ”¹åŠ¨
  1. åŒå±‚çº§æ¯”è¾ƒï¼šä¸è·¨å±‚å¯¹æ¯”èŠ‚ç‚¹ï¼Œæå‡æ€§èƒ½
  2. åŒç±»å‹èŠ‚ç‚¹ç»§ç»­æ¯”å¯¹ï¼šä¸åŒç±»å‹ç›´æ¥æ›¿æ¢
  3. åˆ—è¡¨æ¯”å¯¹ä¼˜åŒ–ï¼škey æå‡æ€§èƒ½
     > diff ä¸ç”¨â€œé€èŠ‚ç‚¹å…¨é‡æ¯”è¾ƒçš„åŸå› ï¼šå…¨é‡å¯¹æ¯”æ—¶é—´å¤æ‚åº¦ O(nÂ³)ï¼ŒReact/Vue ç”¨é€å±‚å¯¹æ¯”æŠŠå¤æ‚åº¦é™åˆ° O(n)ã€‚
- keyï¼šå”¯ä¸€æ ‡è¯†èŠ‚ç‚¹
  > key ä¸ºä»€ä¹ˆä¸èƒ½ç”¨ç´¢å¼•ï¼Ÿ ğŸ‘‰ ç´¢å¼•ä¼šéšä½ç½®å˜åŒ–ï¼Œå¯¼è‡´èŠ‚ç‚¹é”™ä½æ›´æ–°ï¼Œå‡ºç°é‡æ¸²æŸ“ã€çŠ¶æ€é”™ä¹±

## å‡½æ•°å¼ç¼–ç¨‹

ä¸å¯å˜å€¼ï¼š

- æ•°ç»„ï¼šä¸èƒ½å¯¹æ•°ç»„ç±»å‹çš„ state å˜é‡è¿›è¡Œ push/pop/splice ç­‰æ“ä½œ
- å¯¹è±¡ï¼šä¸èƒ½ç›´æ¥å¯¹ Object ç±»å‹çš„ state å˜é‡è¿›è¡Œå±æ€§è®¾ç½®ï¼Œæ¯”å¦‚ `this.state.obj.xx`

## JSX æœ¬è´¨

JSX ç­‰åŒäº Vue æ¨¡æ¿ï¼Œ

## React åˆæˆäº‹ä»¶æœºåˆ¶

## setState å’Œ batchUpdate

## ç»„ä»¶æ¸²æŸ“è¿‡ç¨‹

## å‰ç«¯è·¯ç”±

## é”™è¯¯è¾¹ç•Œ

è§£å†³é—®é¢˜ï¼šéƒ¨åˆ† UI çš„ JavaScript é”™è¯¯å¯¼è‡´æ•´ä¸ªåº”ç”¨å´©æºƒ

æœ¬è´¨ï¼šReact ç»„ä»¶ï¼Œå¯ä»¥æ•è·å‘ç”Ÿåœ¨å…¶å­ç»„ä»¶æ ‘ä»»ä½•ä½ç½®çš„ JavaScript é”™è¯¯ï¼Œå¹¶æ‰“å°è¿™äº›é”™è¯¯ï¼ŒåŒæ—¶å±•ç¤ºé™çº§ UIï¼Œå¹¶ä¸ä¼šæ¸²æŸ“é‚£äº›å‘ç”Ÿå´©æºƒçš„å­ç»„ä»¶æ ‘ï¼›ä¸”å¯ä»¥æ•è·å‘ç”Ÿåœ¨æ•´ä¸ªå­ç»„ä»¶æ ‘çš„æ¸²æŸ“æœŸé—´ã€ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä»¥åŠæ„é€ å‡½æ•°ä¸­çš„é”™è¯¯ã€‚

æ— æ³•æ•è·çš„åœºæ™¯ï¼š

- äº‹ä»¶å¤„ç†
- å¼‚æ­¥ä»£ç ï¼ˆä¾‹å¦‚ setTimeout æˆ– requestAnimationFrame å›è°ƒå‡½æ•°ï¼‰
- æœåŠ¡ç«¯æ¸²æŸ“
- å®ƒè‡ªèº«æŠ›å‡ºæ¥çš„é”™è¯¯ï¼ˆå¹¶éå®ƒçš„å­ç»„ä»¶ï¼‰

å®šä¹‰æ–¹æ³•ï¼š
class ç»„ä»¶ä¸­å®šä¹‰äº†`static getDerivedStateFromError()`æˆ–è€…`componentDidCatch()`è¿™ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸæ–¹æ³•çš„ä¸€ä¸ªï¼Œè¿™ä¸ª class ç»„ä»¶å°±æ˜¯ä¸€ä¸ªé”™è¯¯è¾¹ç•Œ

```jsx
class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false };
  }
  static getDerivedStateFromError(error) {
    // æ›´æ–° state ä½¿ä¸‹ä¸€æ¬¡æ¸²æŸ“èƒ½å¤Ÿæ˜¾ç¤ºé™çº§åçš„ UI
    return { hasError: true };
  }
  componentDidCatch(error, errorInfo) {
    // ä½ åŒæ ·å¯ä»¥å°†é”™è¯¯æ—¥å¿—ä¸ŠæŠ¥ç»™æœåŠ¡å™¨
    logErrorToMyService(error, errorInfo);
  }
  render() {
    if (this.state.hasError) {
      // ä½ å¯ä»¥è‡ªå®šä¹‰é™çº§åçš„ UI å¹¶æ¸²æŸ“
      return <h1>Something went wrong.</h1>;
    }
    return this.props.children;
  }
}
//ä½¿ç”¨
<ErrorBoundary>
  <MyWidget />
</ErrorBoundary>;
```

è¯¥åŠŸèƒ½åœ¨å‡½æ•°ç»„ä»¶ä¸­å·²ç»åºŸå¼ƒï¼Œå¯é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°ï¼š

1. ä½¿ç”¨ ErrorBoundary ç±»ç»„ä»¶ ä½œä¸ºé«˜é˜¶ç»„ä»¶
2. é‡‡ç”¨ç¬¬ä¸‰æ–¹åº“ï¼Œæ¯”å¦‚ react-error-boundary çš„ useErrorBoundary
